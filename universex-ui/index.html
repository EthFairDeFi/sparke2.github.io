<!-- <pre style="width: 100%; height: 100%; margin:0px; "></pre> -->

<div id="header_txt" style="width: 30%; height: 5%; padding-bottom: 10px;"> Author & C++: <a href="https://github.com/Dexaran/">@Dexaran</a> (dexaran@ethereumclassic.org) <br> UI: <a href="https://github.com/Sparke2/">@Sparke2</a> (ligreat875@gmail.com) </div>
<button id="switch_to_grid_btn" style="margin-left: 15%; margin-top: -25px; position: absolute;" onclick="initGridView()"> Switch to grid view </button>
<button id="switch_to_text_btn" style="margin-left: 15%; margin-top: -25px; position: absolute;" onclick="initTextView()"> Switch to sector list </button>
<input id="player_name_input" type="text" name="player_name" style="margin-left: 25%; margin-top: -25px; position: absolute;" value="dexaraniiznx">
<p id="player_name_description" style="margin-left: 25%; margin-top: -42px; position: absolute;"> Player name: </p>
<div style="margin-left: 40%; margin-top: -45px; position: absolute; font-size: 31;"> Universe X <a href="https://eos.io/">EOSIO</a> smart-contract UI</div>


<!--- PLANETARY MODE SCREEN -->
  <div id="planetScreen" class="planetmode" style="width: 70%; height: 80%; background-color: #E2E2E2; position: fixed; margin-left: 10%; margin-top: 0%; display: none;">


    <div id="planet_upper_bar" class="itemholder" style="margin-left: 1%; margin-top: 1%; width: 98%; height: 6%; position: absolute;">
      <p id="planet_description" style="margin-left: 1%; margin-top: 0%; position: absolute;">Planet ID:  </p>
      <p id="planet_position_xy" style="margin-left: 11%; margin-top: 0%; position: absolute;"></p>
      <p id="planet_update_text" style="margin-left: 1%; margin-top: 2%; position: absolute;">Updated: </p>
      <p id="planet_update" style="margin-left: 6%; margin-top: 2%; position: absolute;"></p>
      <p id="planet_owner_text" style="margin-left: 11%; margin-top: 2%; position: absolute;">Owner: </p>
      <p id="planet_owner_name" style="margin-left: 15%; margin-top: 2%; position: absolute;"></p>
      <button style="margin-left: 98%; margin-top: 0%; position: absolute;" onclick="hideAllPlanets()"> X </button>
    </div>
    <div id="buildings" class="itemholder" style="width: 72%; height: 30%; margin-left: 2%; margin-top: 40%; position: absolute; display: none;">
        <div id="buildings_tab_name" style="font-size: 22;">Planetary Landscape and buildings</div> 
  </div>
    <div id="actions" class="itemholder" style="width: 22%; height: 30%; margin-left: 75%; margin-top: 40%; position: absolute; display: none;">

        <div id="actions_tab_name" style="font-size: 22;">Planetary actions</div> 
      <button style="margin-left: 15%; margin-top: 5%; width: 70%; height: 13%; position: absolute;" onclick="showSendFleetMenu()"> Send Fleets Here </button>
      <button style="margin-left: 15%; margin-top: 45%; width: 70%; height: 13%; position: absolute;" disabled="true"> Issue planetary order </button>
      <button style="margin-left: 15%; margin-top: 25%; width: 70%; height: 13%; position: absolute;" disabled="true"> Abandon planet </button>
    </div>
    <div id="fleets" class="fleetlist" style="width: 22%; height: 40%; margin-left: 75%; margin-top: 7%; position: absolute; display: none;">
      
        <div id="fleets_tab_name" style="font-size: 22;">Active fleets and fleet orders</div> 
    </div>
    <div id="deco_landscape" class="itemholder" style="width: 72%; height: 54%; margin-left: 2%; margin-top: 7%; position: absolute;">
      
    </div>
<!--    ------------------------- -->




<!--- SEND FLEET POPUP MENU -->
<div id="sendFleetMenu" class="sendfleetmenu" style="width: 45%; height: 30%; position: fixed; margin-left: 5%; margin-top: 7%; display: none;">


<p style="position: fixed; margin-left: 1%; margin-top: 1%; font-size: 20; color: #FFFFFF;">From: </p>

    <select id="planet_select" onchange="showPlanetFleets()" style="position: fixed; margin-left: 5%; margin-top: 1%; width: 10%; height: 3%;">
      <option value="">chose owned planet</option>
    </select>

      <button style="margin-left: 97%; margin-top: 0%; position: absolute;" onclick="hideSendFleetMenu()"> X </button>


</div>
<!--    ------------------------- -->


</div>
<div id="main_holder" style="width: 100%; height: 100%; margin:0px;"></div>

<script src='dist-web/eosjs-api.js'></script>
<script src='dist-web/eosjs-jsonrpc.js'></script>
<script src='dist-web/eosjs-jssig.js'></script>

<style>


div.planetmode {
  z-index: 10;
}
div.sendfleetmenu {
  z-index: 12;
}
div.planetmode {
  opacity: 0.98;
}

  div.itemholder {border-style: groove;}
  div.itemholder {background-color: #92a8d1;}

  div.sendfleetmenu {border-style: groove;}
  div.sendfleetmenu {background-color: #4F4F4F;}

  div.fleetlist {border-style: outset;}
  div.fleetlist {background-color: #309B92;}

  div.outset {border-style: outset;}
  div.groove {border-style: groove;}
  div.groove {background-color: #92a8d1;}


  div.planetmode {border-style: groove;}
</style>

<script>

  // Setting global variables
  /* **************************************************** */

var activate_selection = true;
var temperatures = [];

var player_name = document.getElementById("player_name_input").value;
//console.log(player_name);

// Main elements that will be modified frequently.

  var planetScreen = document.getElementById("planetScreen");
  var planetDescription = document.getElementById("planet_description");
  var planetUpdate = document.getElementById("planet_update");
  var planetPositionXY = document.getElementById("planet_position_xy");
  var planetOwnerName = document.getElementById("planet_owner_name");

  var gridBtn = document.getElementById("switch_to_grid_btn");
  var textBtn = document.getElementById("switch_to_text_btn");

  var active_view = "text"; // For autoupdate to re-init view that is currently selected by user.

// SET TIMER
// Incrementing the "Last updated" counters by 1 each second.
var sec_timer = setInterval(function() {

  var timerNow = planetUpdate.innerHTML;
  timerNow++;
  planetUpdate.innerHTML = timerNow;
              
}, 1000);
// END TIMER

// SET AUTO RE-INIT once per update cycle to be up-to-date with the contract state
// Reinit the selected map section
var cyclic_update_timer = setInterval(function() {

  if(active_view == "text")
  {
    initTextView();
    console.log("reiniting TEXT VIEW");
  }
  else if (active_view == "grid")
  {
    initGridView();
    console.log("reiniting GRID VIEW");
  }
              
}, 90000);
// END TIMER

/* ************************************** */
// End global variables

  // Super easy color change function.
function selectOn(element) {
  if(activate_selection)
  {
    element.style.background = "PaleGreen";
  }
}
function selectOff(element) {
  if(activate_selection)
  {
    element.style.background = 'transparent';
  }
}
function expand(itr) {
  console.log(itr);
  var el = document.getElementById("div" + itr);
  el.style.height = "250px";
}


/*
function showPlanet(id)
{
  var el = document.getElementById("planetScreen" + id);
  //var id_hldr = document.getElementById("id_holder");
  //var planet_dscr = document.getElementById("planet_description");
  //id_hldr.innerHTML = id;
  el.style.display = "inline";
  activate_selection = false;
}
*/

function showPlanetaryElements()
{
  showBuildings();
  showFleets();
  showActions();
}

function hidePlanetaryElements()
{
  hideBuildings();
  hideFleets();
  hideActions();
}


function showBuildings()
{
  var el = document.getElementById("buildings");
  el.style.display = "inline";
}

function hideBuildings()
{
  var el = document.getElementById("buildings");
  el.style.display = "none";
}


function showSendFleetMenu()
{
  // First load the planets owned by current player

  var el = document.getElementById("sendFleetMenu");
  var planets_dropdown = document.getElementById("planet_select");
  planets_dropdown.innerHTML = `<option value="">choose owned planet</option>`;

  var res = rpc.get_table_rows({
    code:'dexaraniiznx',
    scope:'dexaraniiznx',
    table:'sector',
    json: true,        
    limit: 1000,               
    reverse: false
    }).then(function(res){
      for(i=0; i<res.rows.length; i++)
      {
        console.log(res.rows[i].owner_name);
        if(res.rows[i].owner_name == player_name)
        {
          planets_dropdown.innerHTML += `<option value="` + i + `">Planet ` + i + `</option>`;
        }
      }
    });
  el.style.display = "inline";
}

function hideSendFleetMenu()
{
  var el = document.getElementById("sendFleetMenu");
  el.style.display = "none";
}

function showPlanetFleets()
{
  var planet_id = document.getElementById("planet_select").value;
  console.log("Fleets at planet " + planet_id);
}


function showActions()
{
  var el = document.getElementById("actions");
  el.style.display = "inline";
}

function hideActions()
{
  var el = document.getElementById("actions");
  el.style.display = "none";
}

function showFleets()
{
  var el = document.getElementById("fleets");
  el.style.display = "inline";
}

function hideFleets()
{
  var el = document.getElementById("fleets");
  el.style.display = "none";
}

function showPlanet(id)
{
  planetScreen = document.getElementById("planetScreen");
  planetDescription = document.getElementById("planet_description");
  planetUpdate = document.getElementById("planet_update");

    var res = rpc.get_table_rows({
    code:'dexaraniiznx',
    scope:'dexaraniiznx',
    table:'sector',
    json: true,        
    limit: 1000,               
    reverse: false
    }).then(function(res){
  
        //pre.textContent += '\n\n' + JSON.stringify(res, null, 2);

      for(i=0; i<res.rows.length;i++)
      {
        if(i == id)
        {
          if(res.rows[i].has_planet)
          {

            /* DRAWING A PLANET ************************/
            showPlanetaryElements();

            planetDescription.innerHTML = "Planet ";
            planetDescription.innerHTML += id;

            planetOwnerName.innerHTML  = "";
            if(res.rows[i].owner_name != "")
            {
              planetOwnerName.innerHTML  += res.rows[i].owner_name;
            }
            else
            {
              planetOwnerName.innerHTML  += "no owner";
            }

            var date = new Date();
            var timestamp = date.getTime(); // Returns data in MICROSECONDS
                                        // Needs to be converted to SECONDS as uint64_t outputs now() in seconds.
            var diff = Math.round(timestamp / 1000) - res.rows[i].last_updated[0];
            planetUpdate.innerHTML = diff;

          }
          else 
          {
            /* EMPTY SECTOR selected *******************/
            hidePlanetaryElements();

            planetDescription.innerHTML = "Empty sector ";
          }

          /* Fill vatiables that are relevant for both sectors and planets */

          planetPositionXY.innerHTML = "[";
          planetPositionXY.innerHTML += res.rows[i].x;
          planetPositionXY.innerHTML += " : ";
          planetPositionXY.innerHTML += res.rows[i].y;
          planetPositionXY.innerHTML += "]";
        }
      }
  });

  planetScreen.style.display = "inline";
}

function hidePlanet(id)
{
  //var el = document.getElementById("planetScreen" + id);
  var el = document.getElementById("planetScreen");
  el.style.display = "none";
  activate_selection = true;
  /*
  var id_hldr = document.getElementById("id_holder");
  var div_id = "div" + id;
  var div_to_hide = document.getElementById(div_id);
  selectOff(div_to_hide);
  */
}


function hideAllPlanets()
{
  for (i=0; i<10000; i++)
  {
    hidePlanet(i);
  }
}

function loadPlanetScreen(id)
{
  var planetScreen = "";
  planetScreen += `<div id="planetScreen` + id + `" class="planetmode" style="width: 80%; height: 80%; background-color: #E2E2E2; position: fixed; margin-left: 10%; margin-top: 3%; display: none;">`

  planetScreen += `<button style="margin-left: 95%; margin-top: 2%; position: relative;" onclick="hidePlanet(` + i + `)"> X </button>`;
  planetScreen += `<div style="margin-left: 4%; margin-top: 10%; position: relative; font-size: 22;"><div style="display: none;" id="idHolder` + i +  `">` + i + `</div><p id="planet_description">Planet ID:  </p></div>`;

  planetScreen += 
  planetScreen += `<div id="buildings` + id + `" class="itemholder" style="width: 96%; height: 35%; position: relative; margin-left: 2%; margin-right: 2%; margin-top: 65%;">`
  planetScreen += `</div>`; // Building cells submenu
  planetScreen += `</div>`; // Main div
  
  var el = document.getElementById("planetary_mode");
  el.innerHTML += planetScreen;
}


function initGridView() {

  content = "";
  active_view = "grid";

  gridBtn.style.display = "none";
  textBtn.style.display = "inline";
  activate_selection = true;

  var res = rpc.get_table_rows({
    code:'dexaraniiznx',
    scope:'dexaraniiznx',
    table:'sector',
    json: true,        
    limit: 1000,               
    reverse: false
}).then(function(res){
  
        //pre.textContent += '\n\n' + JSON.stringify(res, null, 2);

      for(i=0; i<res.rows.length;i++)
      {

        //loadPlanetScreen(i);
        
        // For each ROW in the table add a special planet-holder div
        // and fill its content with planetary (or empty sector) variables.
        var div_text = "sector: ";
        var div_style = "groove";
        if(res.rows[i].has_planet)
        {
          div_text = "planet: ";
          div_style = "outset";
        }
        div_text += res.rows[i].id;

        content += `<div id="div` + i + `" onmouseover="selectOn(this)" onclick="showPlanet(` + i + `)" onmouseout="selectOff(this)" style="width: 75px; height: 75px;" class="` + div_style + `">`;
        content += `<div style="margin-top: 5px; margin-left: 5px;" >` + div_text + `</div>`;
        if(res.rows[i].has_planet)
        {
          content += `<img src="planet.png" height="45" width="45" style="margin-bottom: 5px; margin-left: 11px;">`;
        }

        var date = new Date();
        var timestamp = date.getTime(); // Returns data in MICROSECONDS
                                        // Needs to be converted to SECONDS as uint64_t outputs now() in seconds.
        var diff = Math.round(timestamp / 1000) - res.rows[i].last_updated[0];
        temperatures[i] = res.rows[i].temperature;


        content += `</div>`;
      }
      document.getElementById("main_holder").innerHTML = content;
      for (j = 0; j<res.rows.length;j++)
      {
        // Then apply the position

        var mainholder = document.getElementById("main_holder");
        mainholder = mainholder.getBoundingClientRect();
        var offset_x = mainholder.x + 5;
        var offset_y = mainholder.y + 5;
        console.log("X:" + offset_x + " Y:" + offset_y);

        var div_id = "div";
        div_id += j;
        var current_div = document.getElementById(div_id);

        current_div.style.position = "absolute";
        current_div.style.left = res.rows[j].x * 75 + offset_x;
        current_div.style.top = res.rows[j].y * 75 + offset_y;


        //console.log("id " + div_id + " x:" + res.rows[j].x + " y:" + res.rows[j].y);
      }
  });
}


function initTextView()
{
  content = "";
  active_view = "text";

  gridBtn.style.display = "inline";
  textBtn.style.display = "none";
  activate_selection = true;

  const response = rpc.get_table_rows({
    code:'dexaraniiznx',
    scope:'dexaraniiznx',
    table:'sector',
    json: true,        
    limit: 1000,               
    reverse: false
  }).then(async function(res) {


        //pre.textContent += '\n\n' + JSON.stringify(res, null, 2);
      for(i=0; i<res.rows.length;i++)
      {
        
        // For each ROW in the table add a special planet-holder div
        // and fill its content with planetary (or empty sector) variables.
        var div_height = "30px;";
        var div_description_txt = "Empty sector ";
        
        //loadPlanetScreen(i);
        
        if(res.rows[i].has_planet)
        {
          div_description_txt = "Planet ";
          div_height = "70px";
        }
        content += `<div id="div` + i + `" onmouseover="selectOn(this)" onclick="showPlanet(` + i + `)" onmouseout="selectOff(this)" style="margin-bottom: 12px; width: 100%; height: ` + div_height + `" class="outset">`;
        content += `<div style="margin-left: 10px; margin-top: 5px; position: absolute;">` + div_description_txt + "" + res.rows[i].id + `</div>`;
        if(res.rows[i].has_planet)
        {
          content += `<img src="planet.png" height="45" width="45" style="margin-top: 20px; margin-left: 6%; position: absolute;">`;
        }
        content += `<div style="margin-left: 18%; margin-top: 5px; position: absolute;"> X: ` + res.rows[i].x + `</div>`;
        content += `<div style="margin-left: 14%; margin-top: 5px; position: absolute;"> Y: ` + res.rows[i].y + `</div>`;
        if(res.rows[i].has_planet)
        {
          content += `<div style="margin-left: 15%; margin-top: 35px; position: absolute;"> Owner: ` + res.rows[i].owner_name + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 10px; position: absolute;"> Metal: ` + res.rows[i].resources[0] + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 28px; position: absolute;"> Crystal: ` + res.rows[i].resources[1] + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 46px; position: absolute;"> Gas: ` + res.rows[i].resources[2] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 10px; position: absolute;"> Battleships: ` + res.rows[i].planetary_fleet.ships[0] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 28px; position: absolute;"> Cargoships: ` + res.rows[i].planetary_fleet.ships[1] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 46px; position: absolute;"> Colonizers: ` + res.rows[i].planetary_fleet.ships[2] + `</div>`;
        }
        content += `<button style="margin-left: 60%; margin-top: 30px; position: absolute;" onclick="expand(` + i + `)" disabled="true"> Expand </button>`;
        var date = new Date();
        var timestamp = date.getTime(); // Returns data in MICROSECONDS
                                        // Needs to be converted to SECONDS as uint64_t outputs now() in seconds.

        var diff = Math.round(timestamp / 1000) - res.rows[i].last_updated[0];
        content += `<div style="margin-left: 73%; margin-top: 30px; position: absolute;"> Last updated: `+ diff +  ` seconds ago </div>`;
        
        //content += `<div style="margin-left: 73%; margin-top: 5px; position: absolute;"> NOW: `+ timestamp +  ` </div>`;

        content += `</div>`;
      }
      document.getElementById("main_holder").innerHTML = content;


      response_json = await res.rows;
      return res;
  });
}
</script>


<script>
  let pre = document.getElementsByTagName('pre')[0];
  const defaultPrivateKey = "5JtUScZK2XEp3g9gh7F8bwtPTRAkASmNrrftmx4AxDKD5K4zDnr"; // bob
  const rpc = new eosjs_jsonrpc.JsonRpc('https://api.eosnewyork.io');
  const signatureProvider = new eosjs_jssig.JsSignatureProvider([defaultPrivateKey]);
  const api = new eosjs_api.Api({ rpc, signatureProvider });

  //console.log( rpc.get_account('dexaraniiznx') );   // <<<==== WORKING!

  var content = "";
  var response_json;

  initTextView();


/*

  const response = rpc.get_table_rows({
    code:'dexaraniiznx',
    scope:'dexaraniiznx',
    table:'sector',
    json: true,        
    limit: 1000,               
    reverse: false
  }).then(async function(res) {


        //pre.textContent += '\n\n' + JSON.stringify(res, null, 2);
      for(i=0; i<res.rows.length;i++)
      {
        
        // For each ROW in the table add a special planet-holder div
        // and fill its content with planetary (or empty sector) variables.
        var div_height = "30px;";
        var div_description_txt = "Empty sector ";
        
        //loadPlanetScreen(i);
        
        if(res.rows[i].has_planet)
        {
          div_description_txt = "Planet ";
          div_height = "70px";
        }
        content += `<div id="div` + i + `" onmouseover="selectOn(this)" onclick="showPlanet(` + i + `)" onmouseout="selectOff(this)" style="margin-bottom: 12px; width: 100%; height: ` + div_height + `" class="outset">`;
        content += `<div style="margin-left: 10px; margin-top: 5px; position: absolute;">` + div_description_txt + "" + res.rows[i].id + `</div>`;
        if(res.rows[i].has_planet)
        {
          content += `<img src="planet.png" height="45" width="45" style="margin-top: 20px; margin-left: 6%; position: absolute;">`;
        }
        content += `<div style="margin-left: 18%; margin-top: 5px; position: absolute;"> X: ` + res.rows[i].x + `</div>`;
        content += `<div style="margin-left: 14%; margin-top: 5px; position: absolute;"> Y: ` + res.rows[i].y + `</div>`;
        if(res.rows[i].has_planet)
        {
          content += `<div style="margin-left: 15%; margin-top: 35px; position: absolute;"> Owner: ` + res.rows[i].owner_name + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 10px; position: absolute;"> Metal: ` + res.rows[i].resources[0] + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 28px; position: absolute;"> Crystal: ` + res.rows[i].resources[1] + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 46px; position: absolute;"> Gas: ` + res.rows[i].resources[2] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 10px; position: absolute;"> Battleships: ` + res.rows[i].planetary_fleet.ships[0] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 28px; position: absolute;"> Cargoships: ` + res.rows[i].planetary_fleet.ships[1] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 46px; position: absolute;"> Colonizers: ` + res.rows[i].planetary_fleet.ships[2] + `</div>`;
        }
        content += `<button style="margin-left: 60%; margin-top: 30px; position: absolute;" onclick="expand(` + i + `)"> Expand </button>`;
        var date = new Date();
        var timestamp = date.getTime(); // Returns data in MICROSECONDS
                                        // Needs to be converted to SECONDS as uint64_t outputs now() in seconds.

        var diff = Math.round(timestamp / 1000) - res.rows[i].last_updated[0];
        content += `<div style="margin-left: 73%; margin-top: 30px; position: absolute;"> Last updated: `+ diff +  ` seconds ago </div>`;
        
        //content += `<div style="margin-left: 73%; margin-top: 5px; position: absolute;"> NOW: `+ timestamp +  ` </div>`;

        content += `</div>`;
      }
      document.getElementById("main_holder").innerHTML = content;


      response_json = await res.rows;
      return res;
  });

  */

console.log("res variable does not work outside the async rpc.get_table_rows function");
//var tmp = JSON.parse(res);
//console.log(res);

</script>
