<!-- <pre style="width: 100%; height: 100%; margin:0px; "></pre> -->

<div id="header_txt" style="width: 30%; height: 5%; padding-bottom: 10px;"> Author & C++: <a href="https://github.com/Dexaran/">@Dexaran</a> (dexaran@ethereumclassic.org) <br> UI: <a href="https://github.com/Sparke2/">@Sparke2</a> (ligreat875@gmail.com) </div>
<button style="margin-left: 25%; margin-top: -25px; position: absolute;" onclick="switchView()"> Switch to grid view </button>
<div style="margin-left: 40%; margin-top: -45px; position: absolute; font-size: 31;"> Universe X <a href="https://eos.io/">EOSIO</a> smart-contract UI</div>
<div id="planetary_mode" style="width: 80%; height: 80%; background-color: #E2E2E2; position: fixed; margin-left: 10%; margin-top: 3%; display: none;">
  

    <button style="margin-left: 95%; margin-top: 2%; position: relative;" onclick="hidePlanet()"> X </button>
    <div style="margin-left: 4%; margin-top: 10%; position: relative; font-size: 22;"> Planet ID:  </div>
    <div id="id_holder" style="margin-left: 15%; margin-top: 10%; position: relative; font-size: 22;"></div>
</div>
<div id="main_holder" style="width: 100%; height: 100%; margin:0px;"></div>

<script src='dist-web/eosjs-api.js'></script>
<script src='dist-web/eosjs-jsonrpc.js'></script>
<script src='dist-web/eosjs-jssig.js'></script>


<style>


#planetary_mode {
  z-index: 10;
}
  div.outset {border-style: outset;}
  div.groove {border-style: groove;}
  div.groove {background-color: #92a8d1;}
  var el = document.getElementById("planetary_mode");
  el.style.opacity = 0.9;
  el.style.order = 119;
</style>

<script>

var activate_selection = true;

  // Super easy color change function.
function selectOn(element) {
  if(activate_selection)
  {
    element.style.background = "PaleGreen";
  }
}
function selectOff(element) {
  if(activate_selection)
  {
    element.style.background = 'transparent';
  }
}
function expand(itr) {
  console.log(itr);
  var el = document.getElementById("div" + itr);
  el.style.height = "250px";
}

function showPlanet(id)
{
  console.log(id);
  var el = document.getElementById("planetary_mode");
  var id_hldr = document.getElementById("id_holder");
  id_hldr.innerHTML = id;
  el.style.display = "inline";
  activate_selection = false;
}

function hidePlanet()
{
  var el = document.getElementById("planetary_mode");
  el.style.display = "none";
  activate_selection = true;
  var id_hldr = document.getElementById("id_holder");
  var div_id = "div" + id_hldr.innerHTML;
  var div_back = document.getElementById(div_id);
  selectOff(div_back);
}


function switchView() {
  var content = "";
  var response_json;

  var res = rpc.get_table_rows({
    code:'dexaraniiznx',
    scope:'dexaraniiznx',
    table:'sector',
    json: true,        
    limit: 1000,               
    reverse: false
}).then(function(res){
  
        //pre.textContent += '\n\n' + JSON.stringify(res, null, 2);

      for(i=0; i<res.rows.length;i++)
      {
        
        // For each ROW in the table add a special planet-holder div
        // and fill its content with planetary (or empty sector) variables.
        var div_text = "sector: ";
        var div_style = "groove";
        if(res.rows[i].has_planet)
        {
          div_text = "planet: ";
          div_style = "outset";

        }
        div_text += res.rows[i].id;

        content += `<div id="div` + i + `" onmouseover="selectOn(this)" onclick="showPlanet(` + i + `)" onmouseout="selectOff(this)" style="width: 75px; height: 75px;" class="` + div_style + `">`;
        content += `<div style="margin-top: 5px; margin-left: 5px;" >` + div_text + `</div>`;
        if(res.rows[i].has_planet)
        {
          content += `<img src="planet.png" height="45" width="45" style="margin-bottom: 5px; margin-left: 11px;">`;
        }

        var date = new Date();
        var timestamp = date.getTime(); // Returns data in MICROSECONDS
                                        // Needs to be converted to SECONDS as uint64_t outputs now() in seconds.
        var diff = Math.round(timestamp / 1000) - res.rows[i].last_updated[0];
        content += `</div>`;
      }
      document.getElementById("main_holder").innerHTML = content;
      for (j = 0; j<res.rows.length;j++)
      {
        // Then apply the position

        var mainholder = document.getElementById("main_holder");
        mainholder = mainholder.getBoundingClientRect();
        var offset_x = mainholder.x + 5;
        var offset_y = mainholder.y + 5;
        console.log("X:" + offset_x + " Y:" + offset_y);

        var div_id = "div";
        div_id += j;
        var current_div = document.getElementById(div_id);

        current_div.style.position = "absolute";
        current_div.style.left = res.rows[j].x * 75 + offset_x;
        current_div.style.top = res.rows[j].y * 75 + offset_y;


        //console.log("id " + div_id + " x:" + res.rows[j].x + " y:" + res.rows[j].y);
      }
  });
}
</script>


<script>
  let pre = document.getElementsByTagName('pre')[0];
  const defaultPrivateKey = "5JtUScZK2XEp3g9gh7F8bwtPTRAkASmNrrftmx4AxDKD5K4zDnr"; // bob
  const rpc = new eosjs_jsonrpc.JsonRpc('https://api.eosnewyork.io');
  const signatureProvider = new eosjs_jssig.JsSignatureProvider([defaultPrivateKey]);
  const api = new eosjs_api.Api({ rpc, signatureProvider });

  //console.log( rpc.get_account('dexaraniiznx') );   // <<<==== WORKING!

  var content = "";
  var response_json;

  var res = rpc.get_table_rows({
    code:'dexaraniiznx',
    scope:'dexaraniiznx',
    table:'sector',
    json: true,        
    limit: 1000,               
    reverse: false
}).then(function(res) {
    console.log(res);

        //pre.textContent += '\n\n' + JSON.stringify(res, null, 2);

      for(i=0; i<res.rows.length;i++)
      {
        
        // For each ROW in the table add a special planet-holder div
        // and fill its content with planetary (or empty sector) variables.
        var div_height = "30px;";
        var div_description_txt = "Empty sector ";
        if(res.rows[i].has_planet)
        {
          div_description_txt = "Planet ";
          div_height = "70px";
        }
        content += `<div id="div` + i + `" onmouseover="selectOn(this)" onclick="showPlanet(` + i + `)" onmouseout="selectOff(this)" style="margin-bottom: 12px; width: 100%; height: ` + div_height + `" class="outset">`;
        content += `<div style="margin-left: 10px; margin-top: 5px; position: absolute;">` + div_description_txt + "" + res.rows[i].id + `</div>`;
        if(res.rows[i].has_planet)
        {
          content += `<img src="planet.png" height="45" width="45" style="margin-top: 20px; margin-left: 6%; position: absolute;">`;
        }
        content += `<div style="margin-left: 18%; margin-top: 5px; position: absolute;"> X: ` + res.rows[i].x + `</div>`;
        content += `<div style="margin-left: 14%; margin-top: 5px; position: absolute;"> Y: ` + res.rows[i].y + `</div>`;
        if(res.rows[i].has_planet)
        {
          content += `<div style="margin-left: 15%; margin-top: 35px; position: absolute;"> Owner: ` + res.rows[i].owner_name + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 10px; position: absolute;"> Metal: ` + res.rows[i].resources[0] + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 28px; position: absolute;"> Crystal: ` + res.rows[i].resources[1] + `</div>`;
          content += `<div style="margin-left: 33%; margin-top: 46px; position: absolute;"> Gas: ` + res.rows[i].resources[2] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 10px; position: absolute;"> Battleships: ` + res.rows[i].planetary_fleet.ships[0] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 28px; position: absolute;"> Cargoships: ` + res.rows[i].planetary_fleet.ships[1] + `</div>`;
          content += `<div style="margin-left: 45%; margin-top: 46px; position: absolute;"> Colonizers: ` + res.rows[i].planetary_fleet.ships[2] + `</div>`;
        }
        content += `<button style="margin-left: 60%; margin-top: 30px; position: absolute;" onclick="expand(` + i + `)"> Expand </button>`;
        var date = new Date();
        var timestamp = date.getTime(); // Returns data in MICROSECONDS
                                        // Needs to be converted to SECONDS as uint64_t outputs now() in seconds.

        var diff = Math.round(timestamp / 1000) - res.rows[i].last_updated[0];
        content += `<div style="margin-left: 73%; margin-top: 30px; position: absolute;"> Last updated: `+ diff +  ` seconds ago </div>`;
        
        //content += `<div style="margin-left: 73%; margin-top: 5px; position: absolute;"> NOW: `+ timestamp +  ` </div>`;

        content += `</div>`;
      }
      document.getElementById("main_holder").innerHTML = content;

});



console.log("res variable does not work outside the async rpc.get_table_rows function");

//var tmp = JSON.parse(res);
//console.log(res);

</script>
